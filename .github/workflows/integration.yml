name: Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  integration:
    name: Integration Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
    - name: Checkout sources
      uses: actions/checkout@v4

    - name: Install stable toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ runner.os }}-cargo-

    - name: Build release binary
      run: cargo build --release --verbose

    - name: Test binary functionality
      shell: bash
      run: |
        # Create test directory structure
        mkdir -p test-data/{dir1,dir2,readonly}
        echo -n "test content 1" > test-data/dir1/video.mkv
        echo -n "test content 2" > test-data/dir2/video.mkv
        echo -n "readonly content" > test-data/readonly/video.mkv

        # Test basic functionality
        ./target/release/torrent-combine test-data --min-file-size 1 --verbose

        # Test with source directories
        ./target/release/torrent-combine test-data --src-dirs test-data/readonly --min-file-size 1 --verbose

        # Test with exclude directories
        ./target/release/torrent-combine test-data --exclude test-data/dir2 --min-file-size 1 --verbose

        # Test cache functionality
        ./target/release/torrent-combine test-data --min-file-size 1 --verbose
        ./target/release/torrent-combine test-data --min-file-size 1 --verbose  # Second run should use cache

        # Test dry run
        ./target/release/torrent-combine test-data --dry-run --min-file-size 1 --verbose
